<!DOCTYPE html>
<html>
<head>
    <title>StihiRus Reader Browser Example</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #output { border: 1px solid #ccc; padding: 10px; margin-top: 10px; max-height: 80vh; overflow-y: auto; background-color: #f9f9f9; }
        pre { background-color: #eee; padding: 8px; border-radius: 4px; white-space: pre-wrap; word-break: break-word; margin-bottom: 10px; font-size: 0.9em;}
        h2 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>StihiRus Reader Browser Test</h1>
    <p>Проверьте консоль браузера (F12) и вывод ниже. Убедитесь, что PROXY_URL и PROXY_API_KEY установлены правильно в скрипте.</p>
    <div id="output">Загрузка...</div>

    <!-- Код библиотеки будет собран Parcel -->
    <script type="module">
        import { getAuthorData, getAuthorFilters } from 'stihirus-reader';

        // --- КОНФИГУРАЦИЯ ---
        const AUTHOR_IDENTIFIER = 'oreh-orehov'; // Или ID, например 14260
        // ВАЖНО: Замените на URL вашего развернутого прокси
        const PROXY_URL = 'https://opex792-corsfix.hf.space'; // например, из Hugging Face Spaces
        // ВАЖНО: Замените на API-ключ вашего прокси (или null, если не нужен)
        const PROXY_API_KEY = 'opex2000';
        // --- КОНЕЦ КОНФИГУРАЦИИ ---

        async function runBrowserExample() {
            console.log(`--- [Браузер] Получение данных через прокси: ${PROXY_URL} ---`);
            const outputDiv = document.getElementById('output');
            if (!outputDiv) {
                console.error("Div для вывода не найден!");
                alert("Div для вывода не найден! Проверьте консоль.");
                return;
            }
            // Очистить предыдущий вывод
            outputDiv.innerHTML = '<h2>Получение данных...</h2>';

            function logToPage(message, isError = false) {
                console[isError ? 'error' : 'log'](message);
                const p = document.createElement('pre');
                p.style.whiteSpace = 'pre-wrap'; // Разрешить перенос строк
                p.style.wordBreak = 'break-word'; // Разрешить перенос слов
                p.textContent = typeof message === 'object' ? JSON.stringify(message, null, 2) : String(message);
                if (isError) p.style.color = 'red';
                outputDiv.appendChild(p);
            }

            logToPage(`Получение данных для: ${AUTHOR_IDENTIFIER} | Страница: 1`);

            try {
                // Получаем основные данные автора (только стр. 1 для краткости)
                const response = await getAuthorData(
                    AUTHOR_IDENTIFIER,
                    1, // Получаем только 1 страницу
                    500, // Задержка (неактуально для одной страницы)
                    PROXY_URL,
                    PROXY_API_KEY
                );

                logToPage("--- Ответ с данными автора ---");
                if (response.status === 'success') {
                    const d = response.data;
                    logToPage(`Автор: ${d.username} (ID: ${d.authorId})`);
                    logToPage(`Каноническое имя: ${d.canonicalUsername}`);
                    logToPage(`URL профиля: ${d.profileUrl}`);
                    logToPage(`Статус: ${d.status}`);
                    logToPage(`Последний визит: ${d.lastVisit}`);
                    logToPage(`URL аватара: ${d.avatarUrl || 'N/A'}`);
                    logToPage(`URL шапки: ${d.headerUrl || 'N/A'}`);
                    logToPage(`Описание:\n${d.description || '(Нет описания)'}`);
                    logToPage(`Статистика: ${JSON.stringify(d.stats)}`);
                    logToPage(`Сборники (${d.collections.length}):`);
                    logToPage(d.collections.length > 0 ? d.collections : '(Нет сборников)');
                    logToPage(`Получено стихов: ${d.poems.length}`);
                    if (d.poems.length > 0) {
                        logToPage(`--- Детали первого стихотворения ---`);
                        // Выводим полный объект первого стиха
                        logToPage(d.poems[0]);
                        if (d.poems.length > 1) {
                            logToPage(`(еще ${d.poems.length - 1} стих(ов) на этой странице не показаны полностью)`);
                        }
                    } else {
                         logToPage('(Стихи на странице 1 не найдены)');
                    }
                } else {
                    logToPage(`ОШИБКА получения данных: ${response.error.message} (Код: ${response.error.code})`, true);
                    if (response.error.originalMessage) logToPage(`Исходная ошибка: ${response.error.originalMessage}`, true);
                    logToPage(response.error); // Выводим полный объект ошибки
                }

                // Получаем доступные фильтры
                logToPage(`\n--- Получение фильтров для: ${AUTHOR_IDENTIFIER} ---`);
                const filtersResponse = await getAuthorFilters(
                    AUTHOR_IDENTIFIER,
                    PROXY_URL,
                    PROXY_API_KEY
                );

                logToPage("--- Ответ с фильтрами ---");
                if (filtersResponse.status === 'success') {
                    const f = filtersResponse.data;
                    logToPage(`Доступные фильтры по рубрикам (${f.rubrics.length}):`);
                    logToPage(f.rubrics.length > 0 ? f.rubrics : '(Нет фильтров по рубрикам)');
                    logToPage(`\nДоступные фильтры по датам (${f.dates.length}):`);
                    logToPage(f.dates.length > 0 ? f.dates : '(Нет фильтров по датам)');
                } else {
                     logToPage(`ОШИБКА получения фильтров: ${filtersResponse.error.message} (Код: ${filtersResponse.error.code})`, true);
                    if (filtersResponse.error.originalMessage) logToPage(`Исходная ошибка: ${filtersResponse.error.originalMessage}`, true);
                    logToPage(filtersResponse.error); // Выводим полный объект ошибки
                }

            } catch (error) {
                logToPage(`НЕПРЕДВИДЕННАЯ ОШИБКА СКРИПТА: ${error}`, true);
                console.error("Непредвиденная ошибка скрипта:", error);
                logToPage(error); // Выводим полный объект ошибки
            } finally {
                // Добавляем финальное сообщение
                 const h2 = outputDiv.querySelector('h2');
                 if (h2) h2.textContent = 'Получение данных завершено.';
                 else {
                     const doneMsg = document.createElement('h2');
                     doneMsg.textContent = 'Получение данных завершено.';
                     outputDiv.insertBefore(doneMsg, outputDiv.firstChild);
                 }
            }
        }

        // Запускаем пример автоматически при загрузке скрипта в браузере
        runBrowserExample();
    </script>
</body>
</html>